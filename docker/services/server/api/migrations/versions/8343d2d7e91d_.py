"""empty message

Revision ID: 8343d2d7e91d
Revises: 0d4fb3f72e6f
Create Date: 2020-06-10 15:22:10.810085

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = "8343d2d7e91d"
down_revision = "0d4fb3f72e6f"
branch_labels = None
depends_on = None

industries = [
    "Airlines",
    "Automotive",
    "CPG",
    "Retail",
    "Telecom",
    "Pharmaceuticals",
    "Banking",
    "Insurance",
    "Technology",
    "E Commerce",
    "Entertainment",
]


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("project", sa.Column("industry", sa.Text(), nullable=True))

    conn = op.get_bind()
    projects = conn.execute(
        sa.text("SELECT id, name FROM project WHERE name LIKE :p1"), p1="% - %"
    ).fetchall()

    print("CODEX >>> PROJECTS | Migrating name to its parts", end="")

    project_updates = 0

    for project in projects:
        project_name_details = project.name.split(" - ")
        if project_name_details[1] in industries:
            conn.execute(
                sa.text(
                    "UPDATE project SET name = :project_name, industry=:project_industry WHERE id = :project_id"
                ),
                project_name=project_name_details[0],
                project_industry=project_name_details[1],
                project_id=project.id,
            )
            print(".", end="")
            project_updates = project_updates + 1

    print("")
    print(f"CODEX >>> PROJECTS | Migrated projects: {project_updates}")
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("project", "industry")
    # ### end Alembic commands ###
